<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VATSIM Pro Radar - Full Functional UI</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --bg-dark: #0c0e14;
            --panel-bg: #11131a;
            --card-bg: #181b24;
            --accent-blue: #3b82f6;
            --text-main: #ffffff;
            --text-dim: #94a3b8;
            --border-color: #242833;
        }

        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg-dark); font-family: 'Inter', 'Microsoft JhengHei', sans-serif; overflow: hidden; color: var(--text-main); }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        
        /* 側邊面板 */
        .side-panel {
            position: absolute; top: 0; left: -380px; z-index: 1000;
            background: var(--panel-bg); width: 360px; height: 100vh;
            display: flex; flex-direction: column; border-right: 1px solid var(--border-color);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .side-panel.active { left: 0; }

        /* 標題與控制項 */
        .panel-header { padding: 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .callsign-brand { font-size: 1.4em; font-weight: bold; color: var(--accent-blue); }
        .header-controls { display: flex; gap: 15px; color: var(--text-dim); }
        .header-controls i { cursor: pointer; transition: 0.2s; padding: 5px; }
        .header-controls i:hover { color: white; }

        /* 分頁 */
        .tabs { display: flex; padding: 0 20px; border-bottom: 1px solid var(--border-color); }
        .tab { flex: 1; padding: 12px 0; text-align: center; cursor: pointer; color: var(--text-dim); font-weight: 600; font-size: 0.9em; }
        .tab.active { color: white; border-bottom: 2px solid var(--accent-blue); }

        /* 內容區 */
        .content-area { flex: 1; overflow-y: auto; padding: 15px; transition: max-height 0.3s ease; }
        .section-title { font-size: 0.75em; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin: 15px 0 10px 5px; display: flex; align-items: center; gap: 5px; }
        .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border-color); }

        .info-block { background: var(--card-bg); border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .label-val { display: flex; margin-bottom: 8px; font-size: 0.85em; }
        .label-text { width: 70px; color: var(--text-dim); }
        .val-text { flex: 1; font-weight: 500; }

        /* 進度條 */
        .flight-path { text-align: center; padding: 10px 0; }
        .apt-row { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em; }
        .progress-container { height: 2px; background: var(--border-color); position: relative; margin: 15px 0; }
        .progress-line { position: absolute; height: 100%; background: var(--accent-blue); width: 0%; transition: width 1s; }
        .progress-plane { position: absolute; top: 50%; transform: translate(-50%, -50%) rotate(90deg); font-size: 12px; transition: left 1s; }

        /* 數據網格 */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-box { background: var(--card-bg); border-radius: 8px; padding: 10px; text-align: center; }
        .stat-label { font-size: 0.65em; color: var(--text-dim); margin-bottom: 4px; }
        .stat-val { font-size: 0.95em; font-weight: bold; }

        /* 底部工具列 */
        .action-footer { display: grid; grid-template-columns: repeat(5, 1fr); background: var(--panel-bg); border-top: 1px solid var(--border-color); }
        .action-item { padding: 15px 0; text-align: center; cursor: pointer; color: var(--text-dim); transition: 0.2s; }
        .action-item i { display: block; font-size: 1.2em; margin-bottom: 5px; }
        .action-item span { font-size: 0.65em; }

        /* 搜尋框 */
        .search-wrap { position: absolute; top: 20px; right: 20px; z-index: 1000; }
        .search-box { width: 240px; background: var(--panel-bg); border: 1px solid var(--border-color); padding: 10px 15px; border-radius: 8px; color: white; outline: none; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    </style>
</head>
<body>

    <div class="search-wrap">
        <input type="text" id="search-box" class="search-box" placeholder="搜尋呼號 (Enter)..." onkeydown="if(event.key==='Enter') handleSearch(this.value)">
    </div>

    <div class="side-panel" id="main-panel">
        <div class="panel-header">
            <div class="top-bar">
                <span class="callsign-brand" id="ui-callsign">---</span>
                <div class="header-controls">
                    <i class="fas fa-thumbtack" title="釘住面板" id="btn-pin"></i>
                    <i class="fas fa-crosshairs" title="定位飛機" id="btn-focus-top"></i>
                    <i class="fas fa-chevron-up" title="收合內容" id="btn-collapse"></i>
                    <i class="fas fa-times" title="關閉" onclick="forceClosePanel()"></i>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active">資訊</div><div class="tab">程序</div><div class="tab">ATC</div>
        </div>

        <div id="scroll-content" class="content-area">
            <div class="section-title">飛行詳情</div>
            <div class="info-block">
                <div class="label-val"><span class="label-text">飛行員</span><span class="val-text" id="ui-pilot">---</span></div>
                <div class="label-val"><span class="label-text">航空公司</span><span class="val-text" id="ui-airline">---</span></div>
            </div>

            <div class="info-block flight-path">
                <div class="apt-row"><span id="ui-dep">---</span><span style="color:var(--accent-blue);font-size:0.7em;">巡航中</span><span id="ui-arr">---</span></div>
                <div class="progress-container"><div class="progress-line" id="ui-progress-bar"></div><div class="progress-plane" id="ui-progress-plane">✈</div></div>
            </div>

            <div class="stats-grid">
                <div class="stat-box"><div class="stat-label">地速</div><div class="stat-val"><span id="ui-gs">0</span> kt</div></div>
                <div class="stat-box"><div class="stat-label">高度</div><div class="stat-val"><span id="ui-alt">0</span> ft</div></div>
                <div class="stat-box"><div class="stat-label">航向</div><div class="stat-val"><span id="ui-hdg">0</span>°</div></div>
            </div>

            <div class="stats-grid">
                <div class="stat-box" style="grid-column: span 1.5;"><div class="stat-label">應答機 (SQ)</div><div class="stat-val" id="ui-sqk">0000</div></div>
                <div class="stat-box" style="grid-column: span 1.5;"><div class="stat-label">通訊頻率</div><div class="stat-val">122.800</div></div>
            </div>
        </div>

        <div class="action-footer">
            <div class="action-item" id="btn-track"><i class="fas fa-location-arrow"></i><span>追蹤</span></div>
            <div class="action-item" id="btn-focus-btm"><i class="fas fa-bullseye"></i><span>聚焦</span></div>
            <div class="action-item" id="btn-route"><i class="fas fa-route"></i><span>航路</span></div>
            <div class="action-item" id="btn-stats"><i class="fas fa-chart-bar"></i><span>數據</span></div>
            <div class="action-item" id="btn-link"><i class="fas fa-share-alt"></i><span>連結</span></div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([23.5, 121], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let planeLayer = L.layerGroup().addTo(map);
        let routeLayer = L.layerGroup().addTo(map);
        let allPilots = [];
        let trackingTarget = null;
        let isPinned = false;
        let isAutoTracking = false;
        let isRouteVisible = true;

        async function fetchData() {
            try {
                const response = await fetch('https://data.vatsim.net/v3/vatsim-data.json');
                const data = await response.json();
                allPilots = data.pilots;
                renderPlanes();
                if (trackingTarget) {
                    const p = allPilots.find(x => x.callsign === trackingTarget);
                    if (p) {
                        updateUI(p);
                        if (isAutoTracking) map.panTo([p.latitude, p.longitude]);
                    }
                }
            } catch (e) {}
        }

        function renderPlanes() {
            planeLayer.clearLayers();
            allPilots.forEach(p => {
                const isSelected = p.callsign === trackingTarget;
                const icon = L.divIcon({
                    className: 'plane-icon',
                    html: `<div style="transform: rotate(${p.heading}deg); color: ${isSelected ? '#3b82f6' : '#ffffff'}; font-size: 20px; text-shadow: 0 0 4px black;">✈</div>`,
                    iconSize: [20, 20], iconAnchor: [10, 10]
                });
                const marker = L.marker([p.latitude, p.longitude], { icon: icon });
                marker.on('click', (e) => { L.DomEvent.stopPropagation(e); openPanel(p); });
                marker.addTo(planeLayer);
            });
        }

        function openPanel(p) {
            trackingTarget = p.callsign;
            updateUI(p);
            document.getElementById('main-panel').classList.add('active');
            bindButtons(p);
        }

        function updateUI(p) {
            document.getElementById('ui-callsign').innerText = p.callsign;
            document.getElementById('ui-pilot').innerText = p.name;
            document.getElementById('ui-gs').innerText = p.groundspeed;
            document.getElementById('ui-alt').innerText = p.altitude.toLocaleString();
            document.getElementById('ui-hdg').innerText = p.heading;
            document.getElementById('ui-sqk').innerText = p.transponder;
            document.getElementById('ui-dep').innerText = p.flight_plan?.departure || "---";
            document.getElementById('ui-arr').innerText = p.flight_plan?.arrival || "---";
            document.getElementById('ui-airline').innerText = p.flight_plan?.remarks.slice(0, 25) || "未知航空公司";
            
            let progress = Math.min(Math.max((p.groundspeed / 500) * 100, 15), 85); 
            document.getElementById('ui-progress-bar').style.width = progress + "%";
            document.getElementById('ui-progress-plane').style.left = progress + "%";
        }

        function bindButtons(p) {
            // 頂部功能
            document.getElementById('btn-pin').onclick = (e) => {
                isPinned = !isPinned;
                e.target.style.color = isPinned ? '#3b82f6' : '';
            };
            document.getElementById('btn-focus-top').onclick = () => map.flyTo([p.latitude, p.longitude], 10);
            document.getElementById('btn-collapse').onclick = (e) => {
                const content = document.getElementById('scroll-content');
                const isHidden = content.style.display === 'none';
                content.style.display = isHidden ? 'block' : 'none';
                e.target.className = isHidden ? 'fas fa-chevron-up' : 'fas fa-chevron-down';
            };

            // 底部功能
            const btnTrack = document.getElementById('btn-track');
            btnTrack.onclick = () => {
                isAutoTracking = !isAutoTracking;
                btnTrack.style.color = isAutoTracking ? '#3b82f6' : '';
            };
            document.getElementById('btn-focus-btm').onclick = () => map.flyTo([p.latitude, p.longitude], 10);
            document.getElementById('btn-link').onclick = () => {
                navigator.clipboard.writeText(`https://stats.vatsim.net/search/${p.cid}`);
                alert("已複製飛行員統計連結");
            };
            document.getElementById('btn-stats').onclick = () => alert(`呼號: ${p.callsign}\n座標: ${p.latitude.toFixed(2)}, ${p.longitude.toFixed(2)}`);
        }

        function forceClosePanel() {
            isPinned = false; // 強制關閉時忽略釘住狀態
            closePanel();
        }

        function closePanel() {
            if (isPinned) return;
            trackingTarget = null;
            isAutoTracking = false;
            document.getElementById('main-panel').classList.remove('active');
        }

        map.on('click', (e) => { if(e.originalEvent.target.id === 'map') closePanel(); });

        function handleSearch(val) {
            const p = allPilots.find(x => x.callsign === val.toUpperCase());
            if (p) { map.flyTo([p.latitude, p.longitude], 8); openPanel(p); }
            else { alert("找不到該呼號"); }
        }

        fetchData();
        setInterval(fetchData, 30000);
    </script>
</body>
</html>
