<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VATSIM Pro Radar - Premium UI</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <style>
        :root {
            --bg-dark: #0c0e14;
            --panel-bg: #11131a;
            --card-bg: #181b24;
            --accent-blue: #3b82f6;
            --text-main: #ffffff;
            --text-dim: #94a3b8;
            --border-color: #242833;
        }

        html, body { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg-dark); font-family: 'Inter', 'Segoe UI', sans-serif; overflow: hidden; color: var(--text-main); }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; z-index: 1; }
        
        /* 側邊面板 */
        .side-panel {
            position: absolute; top: 0; left: -380px; z-index: 1000;
            background: var(--panel-bg); width: 360px; height: 100vh;
            display: flex; flex-direction: column; border-right: 1px solid var(--border-color);
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .side-panel.active { left: 0; }

        /* 標題與控制項 */
        .panel-header { padding: 20px; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; }
        .callsign-brand { font-size: 1.4em; font-weight: bold; color: var(--accent-blue); }
        .header-controls { display: flex; gap: 15px; color: var(--text-dim); font-size: 0.9em; }
        .header-controls i { cursor: pointer; transition: 0.2s; }
        .header-controls i:hover { color: white; }

        /* 分頁切換 */
        .tabs { display: flex; padding: 0 20px; border-bottom: 1px solid var(--border-color); }
        .tab { flex: 1; padding: 12px 0; text-align: center; cursor: pointer; color: var(--text-dim); font-weight: 600; font-size: 0.9em; position: relative; }
        .tab.active { color: white; background: rgba(59, 130, 246, 0.1); border-radius: 8px 8px 0 0; }
        .tab.active::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 2px; background: var(--accent-blue); }

        /* 內容區塊 */
        .content-area { flex: 1; overflow-y: auto; padding: 15px; }
        .section-title { font-size: 0.75em; color: var(--text-dim); text-transform: uppercase; letter-spacing: 1px; margin: 15px 0 10px 5px; display: flex; align-items: center; gap: 5px; }
        .section-title::after { content: ''; flex: 1; height: 1px; background: var(--border-color); }

        /* 資訊卡片 */
        .info-block { background: var(--card-bg); border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .label-val { display: flex; margin-bottom: 8px; font-size: 0.85em; }
        .label-text { width: 70px; color: var(--text-dim); }
        .val-text { flex: 1; font-weight: 500; }

        /* 飛行進度區 */
        .flight-path { text-align: center; padding: 10px 0; }
        .apt-row { display: flex; justify-content: space-between; font-weight: bold; font-size: 1.1em; margin-bottom: 5px; }
        .progress-container { height: 2px; background: var(--border-color); position: relative; margin: 15px 0; }
        .progress-line { position: absolute; height: 100%; background: var(--accent-blue); width: 0%; transition: width 1s; }
        .progress-plane { position: absolute; top: 50%; transform: translate(-50%, -50%) rotate(90deg); font-size: 12px; transition: left 1s; }
        .dist-info { display: flex; justify-content: space-between; font-size: 0.7em; color: var(--text-dim); font-family: monospace; }

        /* 數據網格 */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-top: 10px; }
        .stat-box { background: var(--card-bg); border-radius: 8px; padding: 10px; text-align: center; }
        .stat-label { font-size: 0.65em; color: var(--text-dim); margin-bottom: 4px; }
        .stat-val { font-size: 0.95em; font-weight: bold; }

        /* 底部行動欄 */
        .action-footer { display: grid; grid-template-columns: repeat(5, 1fr); background: var(--panel-bg); border-top: 1px solid var(--border-color); }
        .action-item { padding: 15px 0; text-align: center; cursor: pointer; color: var(--text-dim); transition: 0.2s; }
        .action-item:hover { color: white; background: rgba(255,255,255,0.05); }
        .action-item i { display: block; font-size: 1.2em; margin-bottom: 5px; }
        .action-item span { font-size: 0.65em; font-weight: 600; }

        /* 搜尋框 */
        .search-wrap { position: absolute; top: 20px; right: 20px; z-index: 1000; }
        .search-box { width: 240px; background: var(--panel-bg); border: 1px solid var(--border-color); padding: 10px 15px; border-radius: 8px; color: white; outline: none; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
    </style>
</head>
<body>

    <div class="search-wrap">
        <input type="text" id="search-box" class="search-box" placeholder="搜尋呼號..." onkeydown="if(event.key==='Enter') handleSearch(this.value)">
    </div>

    <div class="side-panel" id="main-panel">
        <div class="panel-header">
            <div class="top-bar">
                <span class="callsign-brand" id="ui-callsign">AHK217</span>
                <div class="header-controls">
                    <i class="fas fa-thumbtack"></i>
                    <i class="fas fa-crosshairs"></i>
                    <i class="fas fa-chevron-up"></i>
                    <i class="fas fa-times" onclick="closePanel()"></i>
                </div>
            </div>
        </div>

        <div class="tabs">
            <div class="tab active">Info</div>
            <div class="tab">Proc</div>
            <div class="tab">ATC</div>
        </div>

        <div class="content-area">
            <div class="section-title">Flight Details</div>
            
            <div class="info-block">
                <div class="label-val">
                    <span class="label-text">Pilot</span>
                    <span class="val-text" id="ui-pilot">Enrico Lindner EDVK</span>
                </div>
                <div class="label-val" style="font-size: 0.75em; color: var(--text-dim); margin-top: -5px; padding-left: 70px;">
                    Basic Member • 33h total time
                </div>
            </div>

            <div class="info-block">
                <div class="label-val">
                    <span class="label-text">Airline</span>
                    <span class="val-text" id="ui-airline">Ahk Air Hong Kong Limited</span>
                </div>
                <div class="label-val" style="font-size: 0.75em; color: var(--text-dim); margin-top: -5px; padding-left: 70px;">
                    AHK • AIR HONG KONG
                </div>
            </div>

            <div class="info-block flight-path">
                <div class="apt-row">
                    <span id="ui-dep">RJGG</span>
                    <span style="color: var(--accent-blue); font-size: 0.7em; font-weight: normal;">Cruising</span>
                    <span id="ui-arr">VHHH</span>
                </div>
                <div class="progress-container">
                    <div class="progress-line" id="ui-progress-bar"></div>
                    <div class="progress-plane" id="ui-progress-plane">✈</div>
                </div>
                <div class="dist-info">
                    <span id="ui-dist-left">676 NM, Online 02:33</span>
                    <span id="ui-eta">709 NM at 03:54Z in 01:57h</span>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <div class="stat-label">GS</div>
                    <div class="stat-val"><span id="ui-gs">361</span> kts</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Altitude</div>
                    <div class="stat-val"><span id="ui-alt">38000</span> ft</div>
                </div>
                <div class="stat-box">
                    <div class="stat-label">Heading</div>
                    <div class="stat-val"><span id="ui-hdg">242</span>°</div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-box" style="grid-column: span 1.5;">
                    <div class="stat-label">Squawk <i class="far fa-question-circle"></i></div>
                    <div class="stat-val" id="ui-sqk">1000</div>
                </div>
                <div class="stat-box" style="grid-column: span 1.5;">
                    <div class="stat-label">COM1</div>
                    <div class="stat-val">122.800</div>
                </div>
            </div>
        </div>

        <div class="action-footer">
            <div class="action-item"><i class="fas fa-location-arrow"></i><span>Track</span></div>
            <div class="action-item"><i class="fas fa-bullseye"></i><span>Focus</span></div>
            <div class="action-item"><i class="fas fa-route"></i><span>Route</span></div>
            <div class="action-item"><i class="fas fa-chart-bar"></i><span>Stats</span></div>
            <div class="action-item"><i class="fas fa-share-alt"></i><span>Link</span></div>
        </div>
    </div>

    <div id="map"></div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script>
        const map = L.map('map', { zoomControl: false, attributionControl: false }).setView([23.5, 121], 5);
        L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png').addTo(map);

        let planeLayer = L.layerGroup().addTo(map);
        let historyLayer = L.layerGroup().addTo(map);
        let allPilots = [];
        let trackingTarget = null;

        async function fetchData() {
            try {
                const response = await fetch('https://data.vatsim.net/v3/vatsim-data.json');
                const data = await response.json();
                allPilots = data.pilots;
                renderPlanes();
                if (trackingTarget) {
                    const p = allPilots.find(x => x.callsign === trackingTarget);
                    if (p) updateUI(p);
                }
            } catch (e) {}
        }

        function renderPlanes() {
            planeLayer.clearLayers();
            allPilots.forEach(p => {
                const icon = L.divIcon({
                    className: 'plane-icon',
                    html: `<div style="transform: rotate(${p.heading}deg); color: ${p.callsign === trackingTarget ? '#3b82f6' : '#ffffff'}; font-size: 20px; text-shadow: 0 0 4px black;">✈</div>`,
                    iconSize: [20, 20], iconAnchor: [10, 10]
                });
                const marker = L.marker([p.latitude, p.longitude], { icon: icon });
                marker.on('click', (e) => {
                    L.DomEvent.stopPropagation(e);
                    openPanel(p);
                });
                marker.addTo(planeLayer);
            });
        }

        function openPanel(p) {
            trackingTarget = p.callsign;
            updateUI(p);
            document.getElementById('main-panel').classList.add('active');
        }

        function closePanel() {
            trackingTarget = null;
            document.getElementById('main-panel').classList.remove('active');
        }

        function updateUI(p) {
            document.getElementById('ui-callsign').innerText = p.callsign;
            document.getElementById('ui-pilot').innerText = p.name;
            document.getElementById('ui-gs').innerText = p.groundspeed;
            document.getElementById('ui-alt').innerText = p.altitude;
            document.getElementById('ui-hdg').innerText = p.heading;
            document.getElementById('ui-sqk').innerText = p.transponder;
            document.getElementById('ui-dep').innerText = p.flight_plan?.departure || "???";
            document.getElementById('ui-arr').innerText = p.flight_plan?.arrival || "???";
            
            // 航空公司的簡單處理 (VATSIM 資料中通常在 flight_plan)
            document.getElementById('ui-airline').innerText = p.flight_plan?.remarks.includes('AIR HONG KONG') ? 'Ahk Air Hong Kong Limited' : 'Scheduled Airline';

            // 進度條模擬
            let progress = Math.min(Math.max((p.groundspeed / 500) * 100, 15), 85); 
            document.getElementById('ui-progress-bar').style.width = progress + "%";
            document.getElementById('ui-progress-plane').style.left = progress + "%";
        }

        map.on('click', (e) => { if(e.originalEvent.target.id === 'map') closePanel(); });

        function handleSearch(val) {
            const p = allPilots.find(x => x.callsign === val.toUpperCase());
            if (p) {
                map.panTo([p.latitude, p.longitude]);
                openPanel(p);
            }
        }

        fetchData();
        setInterval(fetchData, 30000);
    </script>
</body>
</html>
